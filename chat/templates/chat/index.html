<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmBuddy - AI Agricultural Advisor</title>
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <style>
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .language-select:hover {
            border-color: var(--primary-color);
        }

        .language-select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸŒ¾ FarmBuddy</h2>
                <button id="newChatBtn" class="new-chat-btn">+ New Chat</button>
            </div>
            <div class="conversations-list">
                {% for conv in conversations %}
                <div class="conversation-item {% if conv.id == current_conversation.id %}active{% endif %}"
                    data-id="{{ conv.id }}">
                    <a href="{% url 'conversation' conv.id %}" class="conversation-link" title="{{ conv.title }}">
                        <span class="conversation-title">{{ conv.title }}</span>
                    </a>
                    <div class="conversation-actions">
                        <button class="action-btn rename-btn" title="Rename"
                            onclick="renameConversation({{ conv.id }}, '{{ conv.title|escapejs }}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="action-btn delete-btn" title="Delete"
                            onclick="deleteConversation({{ conv.id }})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-container">
            <div class="chat-header">
                <div class="chat-title-group">
                    <h3>Context-Aware Agricultural Advisor</h3>
                    <p class="subtitle">Type or speak your questions â€¢ Phase 3: Voice-Enabled</p>
                </div>

                <div class="header-controls">
                    <select id="languageSelect" class="language-select" title="Select Language">
                        <option value="en">English ğŸ‡¬ğŸ‡§</option>
                        <option value="ha">Hausa ğŸ‡³ğŸ‡¬</option>
                        <option value="ig">Igbo ğŸ‡³ğŸ‡¬</option>
                        <option value="yo">Yoruba ğŸ‡³ğŸ‡¬</option>
                    </select>
                    <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode">
                        <!-- Sun Icon (shown in dark mode) -->
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <!-- Moon Icon (shown in light mode) -->
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                </div>


            </div>

            <div class="messages-container" id="messagesContainer">
                {% for message in messages %}
                <div class="message {{ message.role }}">
                    <div class="message-avatar">
                        {% if message.role == 'user' %}
                        ğŸ‘¤
                        {% else %}
                        ğŸŒ¾
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-text">{{ message.content }}</div>
                        {% if message.image %}
                        <img src="{{ message.image.url }}" class="message-image"
                            onclick="window.open(this.src, '_blank')">
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                {% if not messages %}
                <div class="welcome-message">
                    <h2>Welcome to FarmBuddy! ğŸŒ¾</h2>
                    <p>I'm your AI agricultural advisor for Nigerian smallholder farmers.</p>
                    <p>Ask me anything about:</p>
                    <ul>
                        <li>ğŸŒ± Crop planting and management</li>
                        <li>ğŸ› Pest control</li>
                        <li>ğŸ’§ Irrigation and soil health</li>
                        <li>ğŸ“Š Farming best practices</li>
                    </ul>
                </div>
                {% endif %}
            </div>

            <div class="input-container">
                <!-- Voice Controls Header -->
                <div class="voice-controls">
                    <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                        <div class="pulse"></div>
                        <span>Listening... (click mic to stop)</span>
                    </div>
                </div>

                <form id="chatForm" class="chat-form">
                    {% csrf_token %}
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button type="button" id="locationBtn" class="location-btn"
                        title="Get local weather for better advice">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </button>
                    <button type="button" id="imageBtn" class="image-btn" title="Upload plant image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z"
                                fill="currentColor" />
                        </svg>
                    </button>
                    <button type="button" id="micBtn" class="mic-btn" title="Click to start/stop recording">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M12 15C13.66 15 15 13.66 15 12V6C15 4.34 13.66 3 12 3C10.34 3 9 4.34 9 6V12C9 13.66 10.34 15 12 15Z"
                                fill="currentColor" />
                            <path
                                d="M17 12C17 14.76 14.76 17 12 17C9.24 17 7 14.76 7 12H5C5 15.53 7.61 18.44 11 18.93V22H13V18.93C16.39 18.44 19 15.53 19 12H17Z"
                                fill="currentColor" />
                        </svg>
                    </button>
                    <textarea id="userInput" name="message" placeholder="Type, speak, or upload an image..."
                        rows="1"></textarea>
                    <button type="submit" id="sendBtn" class="send-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script src="{% static 'js/marked.min.js' %}"></script>
    <script src="{% static 'js/chat.js' %}"></script>
</body>

</html>